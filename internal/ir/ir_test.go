package ir_test

import (
	"encoding/json"
	"testing"
	"time"

	"github.com/cswank/amplifier/internal/ir"
	"github.com/stretchr/testify/assert"
)

const t1 = `["1970-01-01T00:00:13.692507Z","1970-01-01T00:00:13.701546Z","1970-01-01T00:00:13.706032Z","1970-01-01T00:00:13.706611Z","1970-01-01T00:00:13.708269Z","1970-01-01T00:00:13.708852Z","1970-01-01T00:00:13.709401Z","1970-01-01T00:00:13.709983Z","1970-01-01T00:00:13.711642Z","1970-01-01T00:00:13.712225Z","1970-01-01T00:00:13.712773Z","1970-01-01T00:00:13.713356Z","1970-01-01T00:00:13.715014Z","1970-01-01T00:00:13.715597Z","1970-01-01T00:00:13.717255Z","1970-01-01T00:00:13.717838Z","1970-01-01T00:00:13.718388Z","1970-01-01T00:00:13.71897Z","1970-01-01T00:00:13.71952Z","1970-01-01T00:00:13.720102Z","1970-01-01T00:00:13.720652Z","1970-01-01T00:00:13.721235Z","1970-01-01T00:00:13.722894Z","1970-01-01T00:00:13.723475Z","1970-01-01T00:00:13.724026Z","1970-01-01T00:00:13.724608Z","1970-01-01T00:00:13.726268Z","1970-01-01T00:00:13.726849Z","1970-01-01T00:00:13.727401Z","1970-01-01T00:00:13.727982Z","1970-01-01T00:00:13.728533Z","1970-01-01T00:00:13.729115Z","1970-01-01T00:00:13.730775Z","1970-01-01T00:00:13.731357Z","1970-01-01T00:00:13.733016Z","1970-01-01T00:00:13.733599Z","1970-01-01T00:00:13.734149Z","1970-01-01T00:00:13.73473Z","1970-01-01T00:00:13.735281Z","1970-01-01T00:00:13.735863Z","1970-01-01T00:00:13.736414Z","1970-01-01T00:00:13.736995Z","1970-01-01T00:00:13.737546Z","1970-01-01T00:00:13.738126Z","1970-01-01T00:00:13.738678Z","1970-01-01T00:00:13.739259Z","1970-01-01T00:00:13.73981Z","1970-01-01T00:00:13.740392Z","1970-01-01T00:00:13.742051Z","1970-01-01T00:00:13.742632Z","1970-01-01T00:00:13.743183Z","1970-01-01T00:00:13.743764Z","1970-01-01T00:00:13.745425Z","1970-01-01T00:00:13.746006Z","1970-01-01T00:00:13.747667Z","1970-01-01T00:00:13.748246Z","1970-01-01T00:00:13.749907Z","1970-01-01T00:00:13.750488Z","1970-01-01T00:00:13.752149Z","1970-01-01T00:00:13.752728Z","1970-01-01T00:00:13.754391Z","1970-01-01T00:00:13.75497Z","1970-01-01T00:00:13.756632Z","1970-01-01T00:00:13.757212Z","1970-01-01T00:00:13.757765Z","1970-01-01T00:00:13.758345Z","1970-01-01T00:00:13.760006Z","1970-01-01T00:00:13.760584Z","1970-01-01T00:00:13.800504Z","1970-01-01T00:00:13.80955Z","1970-01-01T00:00:13.811783Z","1970-01-01T00:00:13.812365Z"]`

func TestIR(t *testing.T) {
	var times []time.Time
	if !assert.NoError(t, json.Unmarshal([]byte(t1), &times)) {
		return
	}

	x := ir.New()

	for _, t := range times {
		x.Add(t)
	}

	if !assert.True(t, x.Ready()) {
		return
	}

	addr, cmd, err := x.Result()
	if !assert.NoError(t, err) {
		return
	}

	assert.Equal(t, uint8(0x35), addr)
	assert.Equal(t, uint8(0x40), cmd)
}
